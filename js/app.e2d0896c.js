(function(t){function e(e){for(var a,r,c=e[0],i=e[1],l=e[2],h=0,u=[];h<c.length;h++)r=c[h],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&u.push(o[r][0]),o[r]=0;for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(t[a]=i[a]);d&&d(e);while(u.length)u.shift()();return n.push.apply(n,l||[]),s()}function s(){for(var t,e=0;e<n.length;e++){for(var s=n[e],a=!0,c=1;c<s.length;c++){var i=s[c];0!==o[i]&&(a=!1)}a&&(n.splice(e--,1),t=r(r.s=s[0]))}return t}var a={},o={app:0},n=[];function r(e){if(a[e])return a[e].exports;var s=a[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=t,r.c=a,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(s,a,function(e){return t[e]}.bind(null,a));return s},r.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/nnchat-vue/";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],i=c.push.bind(c);c.push=e,c=c.slice();for(var l=0;l<c.length;l++)e(c[l]);var d=i;n.push([1,"chunk-vendors"]),s()})({0:function(t,e){},"034f":function(t,e,s){"use strict";var a=s("85ec"),o=s.n(a);o.a},"043a":function(t,e,s){"use strict";var a=s("764a"),o=s.n(a);o.a},"0a3c":function(t,e,s){},"0f7d":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"message-wrapper row",class:[t.message.received?"start-xs":"end-xs"]},[s("div",{staticClass:"message",class:[t.message.received?"received":"sent"]},[t._v(" "+t._s(t.message.content)+" ")])])},o=[],n={props:["message"]},r=n,c=(s("043a"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"ca8f651a",null);e["default"]=i.exports},"0fc3":function(t,e,s){"use strict";var a=s("dd5c"),o=s.n(a);o.a},1:function(t,e,s){t.exports=s("56d7")},"107c":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{staticClass:"user-wrapper row middle-xs"},[t.$store.state.selectedChat?s("div",{staticClass:"col-xs"},[t._v(" "+t._s(t.$store.state.contacts[t.$store.state.selectedChat].name)+" ")]):t._e(),t.$store.state.canConnect?t._e():s("div",{staticClass:"col-xs end-xs error"},[t._v(" Connection lost ")])]),s("div",{staticClass:"messages-wrapper"},[t.$store.state.selectedChat?s("messages",{attrs:{chat:t.$store.state.chats[t.$store.state.selectedChat]}}):t._e()],1),s("div",{staticClass:"input-wrapper row middle-xs"},[s("div",{staticClass:"col-xs"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.message,expression:"message"}],staticClass:"input-field",attrs:{type:"text"},domProps:{value:t.message},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.sendMessage(e)},input:function(e){e.target.composing||(t.message=e.target.value)}}})])])])},o=[],n={data(){return{message:""}},methods:{sendMessage(){if(0==this.message.length||null==this.$store.state.selectedChat)return;let t={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}},e=this.encryptMsg(this.message);console.log(e),this.$http.post(this.$store.state.apiURL+"send/",{receiver:this.$store.state.selectedChat,message:e},t).then(t=>{console.log("message sent."),console.log(t.body)},t=>{console.log(t)}),this.$store.state.chats[this.$store.state.selectedChat].push({received:!1,content:this.message}),this.$idbSet("chats",this.$store.state.chats).then(()=>{let t=document.getElementById("messages");t.scrollTop=t.scrollHeight}),this.message=""},generateKey(t){let e=this.$sha2(t),s=Uint8Array.from(e),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},encryptMsg(t){console.log(`original message: ${t}`);let e=this.generateKey(this.$store.state.contacts[this.$store.state.selectedChat].key),s=this.$aes.utils.utf8.toBytes(t),a=new this.$aes.ModeOfOperation.ctr(e,new this.$aes.Counter(5)),o=a.encrypt(s),n=this.$aes.utils.hex.fromBytes(o);return console.log(`encrypted: ${n}`),n}}},r=n,c=(s("45bb"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"2adcd704",null);e["default"]=i.exports},2:function(t,e){},"284c":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"messages",attrs:{id:"messages"}},t._l(t.chat,(function(t){return s("message",{attrs:{message:t}})})),1)},o=[],n={props:["chat"]},r=n,c=(s("9325"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"b8a35836",null);e["default"]=i.exports},3:function(t,e){},4:function(t,e){},"45bb":function(t,e,s){"use strict";var a=s("5775"),o=s.n(a);o.a},5:function(t,e){},"56d7":function(t,e,s){"use strict";s.r(e);var a=s("2b0e"),o=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},n=[],r={created(){this.getStoredData()},methods:{getStoredData(){this.$idbGet("chats").then(t=>{void 0===t?(console.log("stored chats not found..."),this.$idbSet("chats",{}).then(()=>{console.log("empty chats list created.")})):this.$store.state.chats=t}),this.$idbGet("contacts").then(t=>{void 0===t?(console.log("stored contacts not found..."),this.$idbSet("contacts",{}).then(()=>{console.log("empty contacts list created.")})):this.$store.state.contacts=t}),this.$idbGet("credentials").then(t=>{void 0===t?(console.log("stored credentials not found..."),this.generateCredentials()):(this.$store.state.credentials=t,console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,1e4))})},generateCredentials(){this.$forge.prime.generateProbablePrime(1024,(t,e)=>{this.$store.state.credentials={id:this.$randomString.generate(150),password:this.$randomString.generate(30),secret:e.toString(),lastReceived:0},console.log("new credentials generated."),this.register()})},register(){let t={username:this.$store.state.credentials.id,password:this.$store.state.credentials.password};this.$http.post(this.$store.state.apiURL+"auth/register/",t).then(t=>{t.body.hasOwnProperty("success")&&0==t.body.success?(console.log("user already exists, generating new credentials..."),this.generateCredentials()):t.body.refresh&&t.body.access?(this.$store.state.credentials.refreshToken=t.body.refresh,this.$store.state.credentials.accessToken=t.body.access,this.$idbSet("credentials",this.$store.state.credentials).then(()=>{console.log("new credentials stored."),console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,1e4)})):(console.log("tokens not received: "),console.log(t))},t=>{console.log("error:"),console.log(t)})},generateKey(t){let e=this.$sha2(t),s=Uint8Array.from(e),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},decryptMsg(t){let e=this.generateKey(this.$store.state.contacts[this.$store.state.selectedChat].key),s=new this.$aes.ModeOfOperation.ctr(e,new this.$aes.Counter(5)),a=this.$aes.utils.hex.toBytes(t),o=s.decrypt(a),n=this.$aes.utils.utf8.fromBytes(o);return console.log(`Decrypted: ${n}`),n},getMessages(){let t={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}};this.$http.post(this.$store.state.apiURL+"receive/",{last_message_id:this.$store.state.credentials.lastReceived},t).then(t=>{if(this.$store.state.canConnect=!0,1==t.body.success&&0!=t.body.messages.length)for(let e of t.body.messages)if(this.$store.state.chats.hasOwnProperty(e.sender)){let t=this.decryptMsg(e.message);this.$store.state.chats[e.sender].push({received:!0,content:t}),this.$store.state.credentials.lastReceived=e.id}this.$idbSet("chats",this.$store.state.chats),this.$idbSet("credentials",this.$store.state.credentials)},t=>{console.log("error getting messages:"),"token_not_valid"==t.body.code?(console.log("Token expired."),this.$store.dispatch("refreshToken")):0==t.ok?(console.log("can't connect"),this.$store.state.canConnect=!1):console.log(t)})}}},c=r,i=(s("034f"),s("2877")),l=Object(i["a"])(c,o,n,!1,null,null,null),d=l.exports,h=s("8c4f"),u=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{staticClass:"row"},[s("div",{staticClass:"col-md-2 col-xs-3"},[s("chats")],1),s("div",{staticClass:"col-md-8 col-xs-9 borders"},[s("conversation")],1),s("div",{staticClass:"col-md-2 col-xs-12 add-contact"},[t.$store.state.addContactVisible?s("add-contact"):t._e()],1)])])},p=[],g={},f=g,v=(s("b84c"),Object(i["a"])(f,u,p,!1,null,"77dfacba",null)),m=v.exports;a["a"].use(h["a"]);const b=[{path:"/",name:"frontpage",component:m}],$=new h["a"]({mode:"history",base:"/nnchat-vue/",routes:b});var y=$,C=s("2f62"),_=s("ced0");a["a"].use(C["a"]);var w=new C["a"].Store({state:{addContactVisible:!1,selectedChat:null,contacts:{},chats:{},credentials:{},apiURL:"https://glacial-chamber-87753.herokuapp.com/api/",publicMod:"112457129983317064494133258034491756790943511028023366901014968560410379195027",canConnect:!0},actions:{refreshToken(){let t={headers:{"Content-Type":"application/json"}};this._vm.$http.post(this.state.apiURL+"refresh/",{refresh:this.state.credentials.refreshToken},t).then(t=>{let e=t.body.access;null!=e?(console.log("new access token fetched..."),this.state.credentials.accessToken=e,Object(_["b"])("credentials",this.state.credentials).then(()=>{console.log("token saved.")})):(console.log("couldn't refresh token:"),console.log(t))}).catch(t=>{console.log("error while refreshing token:"),"token_not_valid"==t.body.code&&(console.log("refresh token expired."),this.dispatch("login"))})},login(){let t={username:this.state.credentials.id,password:this.state.credentials.password};this._vm.$http.post(this.state.apiURL+"token/",t).then(t=>{t.body.refresh&&t.body.access?(this.state.credentials.refreshToken=t.body.refresh,this.state.credentials.accessToken=t.body.access,Object(_["b"])("credentials",this.state.credentials).then(()=>{console.log("new tokens stored.")})):(console.log("tokens not received: "),console.log(t))},t=>{console.log("error while logging in:"),console.log(t)})}}}),x=s("28dd"),k=(s("05cc"),s("660e")),O=s("6112"),j=s.n(O),S=s("9a3e"),M=s("7409"),P=s.n(M),R=s("4487"),T=s.n(R),N=s("5c1a"),E=s.n(N),A=s("7247"),D=s.n(A),U=s("ccc2");a["a"].use(j.a),a["a"].use(S["default"]),a["a"].use(x["a"]),a["a"].use(k["a"],{breakpoints:{sm:768,lg:1/0}}),Object.defineProperty(a["a"].prototype,"$bigInt",{value:P.a}),Object.defineProperty(a["a"].prototype,"$randomString",{value:T.a}),Object.defineProperty(a["a"].prototype,"$forge",{value:E.a}),Object.defineProperty(a["a"].prototype,"$aes",{value:D.a}),Object.defineProperty(a["a"].prototype,"$sha2",{value:U["sha512_256"]}),Object.defineProperty(a["a"].prototype,"$idbGet",{value:_["a"]}),Object.defineProperty(a["a"].prototype,"$idbSet",{value:_["b"]}),a["a"].filter("date",(function(t){if(!t)return"";let e=["January","February","March","April","May","June","July","August","September","October","November","December"],s=t.toString().split(" ")[0].replace(/-/g,"/"),a=new Date(s);return e[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()})),a["a"].config.productionTip=!1;const Q=s("6ae9");Q.keys().forEach(t=>{a["a"].component(t.split("/").pop().split(".")[0],Q(t).default||Q(t))}),new a["a"]({router:y,store:w,render:function(t){return t(d)}}).$mount("#app")},5775:function(t,e,s){},6:function(t,e){},"6ae9":function(t,e,s){var a={"./AddContact.vue":"8fd0","./Chat.vue":"e6b0","./Chats.vue":"ac11","./Conversation.vue":"107c","./Message.vue":"0f7d","./Messages.vue":"284c"};function o(t){var e=n(t);return s(e)}function n(t){if(!s.o(a,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return a[t]}o.keys=function(){return Object.keys(a)},o.resolve=n,t.exports=o,o.id="6ae9"},"764a":function(t,e,s){},"7f57":function(t,e,s){"use strict";var a=s("d0a1"),o=s.n(a);o.a},"85ec":function(t,e,s){},"8fd0":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"add-contact"},[s("div",{staticClass:"close row middle-xs",on:{click:t.hideWindow}},[s("div",{staticClass:"col-xs start-xs"},[t._v(" Close ")]),s("div",{staticClass:"col-xs end-xs"},[t._v(" X ")])]),s("div",{staticStyle:{margin:"10px"}},[t._v(" Contact Name ")]),s("input",{directives:[{name:"model",rawName:"v-model",value:t.contactName,expression:"contactName"}],staticStyle:{margin:"10px"},attrs:{type:"text"},domProps:{value:t.contactName},on:{input:function(e){e.target.composing||(t.contactName=e.target.value)}}}),s("div",{staticStyle:{margin:"10px"}},[t._v(" Their code ")]),s("input",{directives:[{name:"model",rawName:"v-model",value:t.contactCode,expression:"contactCode"}],staticStyle:{margin:"10px"},attrs:{type:"text"},domProps:{value:t.contactCode},on:{input:function(e){e.target.composing||(t.contactCode=e.target.value)}}}),s("div",{staticStyle:{margin:"10px"}},[s("button",{on:{click:t.addContact}},[t._v("Add Contact")]),s("br"),s("br"),s("button",{on:{click:function(e){t.addQR=!t.addQR}}},[t._v("Add with QR")]),1==t.addQR?s("div",{attrs:{id:"qr-window"}},[s("qrcode-stream",{on:{decode:t.onQRDecode}})],1):t._e()]),s("div",{staticStyle:{margin:"10px"}},[t._v(" Your QR code ")]),s("qriously",{attrs:{value:t.personalCode,size:177}})],1)},o=[],n=s("ced0"),r={data(){return{addQR:!1,contactName:"",contactCode:"",personalCode:this.$store.state.credentials.id+"_"+this.generatePublic()}},methods:{hideWindow(){this.$store.state.addContactVisible=!1},addContact(){if(0==this.contactName.length)return;if(!this.contactCode.includes("_"))return;let t=this.contactCode.split("_")[0],e=this.generateShared(this.contactCode.split("_")[1]),s={name:this.contactName,key:e};this.$set(this.$store.state.contacts,t,s),this.$set(this.$store.state.chats,t,[]),Object(n["b"])("contacts",this.$store.state.contacts).then(()=>{console.log("contact created..."),Object(n["b"])("chats",this.$store.state.chats).then(()=>{console.log("chat created.")})}),this.hideWindow()},generatePublic(){return this.dh("3",this.$store.state.credentials.secret,this.$store.state.publicMod)},generateShared(t){return this.dh(t,this.$store.state.credentials.secret,this.$store.state.publicMod)},dh(t,e,s){let a=this.$bigInt(t),o=this.$bigInt(e),n=this.$bigInt(s);return a.modPow(o,n).toString()},onQRDecode(t){console.log(`QR code reads: ${t}`),this.contactCode=t}}},c=r,i=(s("0fc3"),s("2877")),l=Object(i["a"])(c,a,o,!1,null,"1421777c",null);e["default"]=l.exports},9325:function(t,e,s){"use strict";var a=s("b1a7"),o=s.n(a);o.a},9587:function(t,e,s){"use strict";var a=s("c391"),o=s.n(a);o.a},ac11:function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chats"},[s("div",{staticClass:"add-contact row middle-xs",on:{click:t.showWindow}},[s("div",{staticClass:"col-xs start-xs"},[t._v(" Add Contact ")]),s("div",{staticClass:"col-xs end-xs"},[t._v(" + ")])]),s("div",{staticClass:"chat-items"},t._l(t.$store.state.contacts,(function(t,e){return s("chat",{attrs:{contact:e}})})),1)])},o=[],n={data(){return{}},methods:{showWindow(){this.$store.state.addContactVisible=!0}}},r=n,c=(s("7f57"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"24668957",null);e["default"]=i.exports},b1a7:function(t,e,s){},b84c:function(t,e,s){"use strict";var a=s("0a3c"),o=s.n(a);o.a},c391:function(t,e,s){},d0a1:function(t,e,s){},dd5c:function(t,e,s){},e6b0:function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chat-item row middle-xs",on:{click:t.selectChat}},[s("div",{staticClass:"user col-xs-12"},[t._v(" "+t._s(t.$store.state.contacts[t.contact].name)+" ")]),s("div",{staticClass:"last-message col-xs-12"},[t._v(" id="+t._s(t.contact)+" key="+t._s(t.$store.state.contacts[t.contact].key)+" ")])])},o=[],n={props:["contact"],methods:{selectChat(){this.$store.state.selectedChat=this.contact}}},r=n,c=(s("9587"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"41978c72",null);e["default"]=i.exports}});
//# sourceMappingURL=app.e2d0896c.js.map