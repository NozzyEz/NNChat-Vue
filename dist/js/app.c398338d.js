(function(e){function t(t){for(var a,r,c=t[0],i=t[1],l=t[2],h=0,u=[];h<c.length;h++)r=c[h],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&u.push(o[r][0]),o[r]=0;for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a]);d&&d(t);while(u.length)u.shift()();return n.push.apply(n,l||[]),s()}function s(){for(var e,t=0;t<n.length;t++){for(var s=n[t],a=!0,c=1;c<s.length;c++){var i=s[c];0!==o[i]&&(a=!1)}a&&(n.splice(t--,1),e=r(r.s=s[0]))}return e}var a={},o={app:0},n=[];function r(t){if(a[t])return a[t].exports;var s=a[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=a,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/nnchat-vue/";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],i=c.push.bind(c);c.push=t,c=c.slice();for(var l=0;l<c.length;l++)t(c[l]);var d=i;n.push([1,"chunk-vendors"]),s()})({0:function(e,t){},"034f":function(e,t,s){"use strict";var a=s("85ec"),o=s.n(a);o.a},"043a":function(e,t,s){"use strict";var a=s("764a"),o=s.n(a);o.a},"0f7d":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"message-wrapper row",class:[e.message.received?"start-xs":"end-xs"]},[s("div",{staticClass:"message",class:[e.message.received?"received":"sent"]},[e._v(" "+e._s(e.message.content)+" ")])])},o=[],n={props:["message"]},r=n,c=(s("043a"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"ca8f651a",null);t["default"]=i.exports},1:function(e,t,s){e.exports=s("56d7")},"107c":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[s("div",{staticClass:"user-wrapper row middle-xs"},["sm"===e.$mq?s("div",{staticClass:"col-xs-1",on:{click:function(t){e.$store.state.contactsVisible=!0}}},[e._v(" ← ")]):e._e(),e.$store.state.selectedChat?s("div",{staticClass:"col-xs"},[e._v(" "+e._s(e.$store.state.contacts[e.$store.state.selectedChat].name)+" ")]):e._e(),e.$store.state.canConnect?e._e():s("div",{staticClass:"col-xs end-xs error"},[e._v(" Connection lost ")])]),s("div",{staticClass:"messages-wrapper"},[e.$store.state.selectedChat?s("messages",{attrs:{chat:e.$store.state.chats[e.$store.state.selectedChat]}}):e._e()],1),s("div",{staticClass:"input-wrapper row middle-xs"},[s("div",{staticClass:"col-xs"},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.message,expression:"message"}],staticClass:"input-field",attrs:{type:"text"},domProps:{value:e.message},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage(t)},input:function(t){t.target.composing||(e.message=t.target.value)}}})])])])},o=[],n={data(){return{message:""}},methods:{sendMessage(){if(0==this.message.length||null==this.$store.state.selectedChat)return;let e=this.encryptMsg(this.message);console.log(e),this.postMessage(e,this.$store.state.selectedChat),this.$store.state.chats[this.$store.state.selectedChat].push({received:!1,content:this.message}),this.$idbSet("chats",this.$store.state.chats).then(()=>{let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}),this.message=""},postMessage(e,t){let s={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}};this.$http.post(this.$store.state.apiURL+"send/",{receiver:t,message:e},s).then(e=>{console.log("message sent."),console.log(e.body)},s=>{console.log(s),this.$store.dispatch("refreshToken").then(s=>{this.postMessage(e,t)},e=>{console.log("couldn't refresh token while sending message.")})})},generateKey(e){let t=this.$sha2(e),s=Uint8Array.from(t),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},encryptMsg(e){console.log(`original message: ${e}`);let t=this.generateKey(this.$store.state.contacts[this.$store.state.selectedChat].key),s=this.$aes.utils.utf8.toBytes(e),a=new this.$aes.ModeOfOperation.ctr(t,new this.$aes.Counter(5)),o=a.encrypt(s),n=this.$aes.utils.hex.fromBytes(o);return console.log(`encrypted: ${n}`),n}}},r=n,c=(s("6dd1"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"d07ce4e8",null);t["default"]=i.exports},"1ca7":function(e,t,s){},2:function(e,t){},"284c":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"messages",attrs:{id:"messages"}},e._l(e.chat,(function(t,a){return s("message",{attrs:{message:t},nativeOn:{click:function(t){return e.deleteMessage(a)}}})})),1)},o=[],n={props:["chat"],methods:{deleteMessage(e){confirm("Delete this message?")&&(console.log("deleting message "+e),this.chat.splice(e,1))}}},r=n,c=(s("a17d"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"7a200ed3",null);t["default"]=i.exports},3:function(e,t){},4:function(e,t){},"442e":function(e,t,s){},"450e":function(e,t,s){"use strict";var a=s("6d0f"),o=s.n(a);o.a},5:function(e,t){},"56d7":function(e,t,s){"use strict";s.r(t);var a=s("2b0e"),o=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},n=[],r={created(){this.getStoredData(),this.$store.state.selectedChat=this.$cookies.get("selectedChat")},methods:{getStoredData(){this.$idbGet("chats").then(e=>{void 0===e?(console.log("stored chats not found..."),this.$idbSet("chats",{}).then(()=>{console.log("empty chats list created.")})):this.$store.state.chats=e}),this.$idbGet("contacts").then(e=>{void 0===e?(console.log("stored contacts not found..."),this.$idbSet("contacts",{}).then(()=>{console.log("empty contacts list created.")})):this.$store.state.contacts=e}),this.$idbGet("credentials").then(e=>{void 0===e?(console.log("stored credentials not found..."),this.generateCredentials()):(this.$store.state.credentials=e,console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,1e4))})},generateCredentials(){this.$forge.prime.generateProbablePrime(1024,(e,t)=>{this.$store.state.credentials={id:this.$randomString.generate(150),password:this.$randomString.generate(30),secret:t.toString(),lastReceived:0},console.log("new credentials generated."),this.register()})},register(){let e={username:this.$store.state.credentials.id,password:this.$store.state.credentials.password};this.$http.post(this.$store.state.apiURL+"auth/register/",e).then(e=>{e.body.hasOwnProperty("success")&&0==e.body.success?(console.log("user already exists, generating new credentials..."),this.generateCredentials()):e.body.refresh&&e.body.access?(this.$store.state.credentials.refreshToken=e.body.refresh,this.$store.state.credentials.accessToken=e.body.access,this.$idbSet("credentials",this.$store.state.credentials).then(()=>{console.log("new credentials stored."),console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,1e4)})):(console.log("tokens not received: "),console.log(e))},e=>{console.log("error:"),console.log(e)})},generateKey(e){let t=this.$sha2(e),s=Uint8Array.from(t),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},decryptMsg(e,t){let s=this.generateKey(this.$store.state.contacts[t].key),a=new this.$aes.ModeOfOperation.ctr(s,new this.$aes.Counter(5)),o=this.$aes.utils.hex.toBytes(e),n=a.decrypt(o),r=this.$aes.utils.utf8.fromBytes(n);return console.log(`Decrypted: ${r}`),r},getMessages(){let e={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}};this.$http.post(this.$store.state.apiURL+"receive/",{last_message_id:this.$store.state.credentials.lastReceived},e).then(e=>{if(this.$store.state.canConnect=!0,console.log(e.body.messages.length+" messages fetched"),console.log(e.body.messages),1==e.body.success&&0!=e.body.messages.length)for(let t of e.body.messages)if(this.$store.state.chats.hasOwnProperty(t.sender)){let e=this.decryptMsg(t.message,t.sender);this.$store.state.chats[t.sender].push({received:!0,content:e}),this.$store.state.credentials.lastReceived=t.id}this.$idbSet("chats",this.$store.state.chats).then(()=>{let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}),this.$idbSet("credentials",this.$store.state.credentials)},e=>{console.log("error getting messages:"),"token_not_valid"==e.body.code?(console.log("Token expired."),this.$store.dispatch("refreshToken")):0==e.ok?(console.log("can't connect"),this.$store.state.canConnect=!1):console.log(e)})}}},c=r,i=(s("034f"),s("2877")),l=Object(i["a"])(c,o,n,!1,null,null,null),d=l.exports,h=s("8c4f"),u=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[s("div",{staticClass:"row"},[e.$store.state.contactsVisible||"lg"===e.$mq?s("div",{staticClass:"col-md-2 col-xs-12 chats"},[s("chats")],1):e._e(),s("div",{staticClass:"col-md-8 col-xs-12 borders"},[s("conversation")],1),e.$store.state.addContactVisible?s("div",{staticClass:"col-md-2 col-xs-12 add-contact"},[s("add-contact")],1):e._e()])])},g=[],p={},f=p,v=(s("7bc7"),Object(i["a"])(f,u,g,!1,null,"b9cdf0e8",null)),m=v.exports;a["a"].use(h["a"]);const $=[{path:"/",name:"frontpage",component:m}],b=new h["a"]({mode:"history",base:"/nnchat-vue/",routes:$});var y=b,C=s("2f62"),w=s("ced0");a["a"].use(C["a"]);var _=new C["a"].Store({state:{addContactVisible:!1,contactsVisible:!1,selectedChat:null,contacts:{},chats:{},credentials:{},apiURL:"https://glacial-chamber-87753.herokuapp.com/api/",publicMod:"112457129983317064494133258034491756790943511028023366901014968560410379195027",canConnect:!0},actions:{refreshToken(){return new Promise((e,t)=>{let s={headers:{"Content-Type":"application/json"}};this._vm.$http.post(this.state.apiURL+"refresh/",{refresh:this.state.credentials.refreshToken},s).then(s=>{let a=s.body.access;null!=a?(console.log("new access token fetched..."),this.state.credentials.accessToken=a,Object(w["b"])("credentials",this.state.credentials).then(()=>{console.log("token saved."),e(s)})):(console.log("couldn't refresh token:"),console.log(s),t(s))}).catch(s=>{console.log("error while refreshing token:"),"token_not_valid"==s.body.code&&(console.log("refresh token expired."),this.dispatch("login").then(t=>{e(t)},e=>{t(e)}))})})},login(){return new Promise((e,t)=>{let s={username:this.state.credentials.id,password:this.state.credentials.password};this._vm.$http.post(this.state.apiURL+"token/",s).then(s=>{s.body.refresh&&s.body.access?(this.state.credentials.refreshToken=s.body.refresh,this.state.credentials.accessToken=s.body.access,Object(w["b"])("credentials",this.state.credentials).then(()=>{console.log("new tokens stored."),e(s)})):(console.log("tokens not received: "),console.log(s),t(s))},e=>{console.log("error while logging in:"),console.log(e),t(e)})})}}}),x=s("28dd"),k=(s("05cc"),s("660e")),O=s("6112"),j=s.n(O),M=s("9a3e"),S=s("7409"),P=s.n(S),T=s("4487"),E=s.n(T),N=s("5c1a"),R=s.n(N),D=s("7247"),A=s.n(D),U=s("ccc2"),V=s("2b27"),B=s.n(V);B.a.config("7d"),a["a"].use(j.a),a["a"].use(M["default"]),a["a"].use(x["a"]),a["a"].use(B.a),a["a"].use(k["a"],{breakpoints:{sm:768,lg:1/0}}),Object.defineProperty(a["a"].prototype,"$bigInt",{value:P.a}),Object.defineProperty(a["a"].prototype,"$randomString",{value:E.a}),Object.defineProperty(a["a"].prototype,"$forge",{value:R.a}),Object.defineProperty(a["a"].prototype,"$aes",{value:A.a}),Object.defineProperty(a["a"].prototype,"$sha2",{value:U["sha512_256"]}),Object.defineProperty(a["a"].prototype,"$idbGet",{value:w["a"]}),Object.defineProperty(a["a"].prototype,"$idbSet",{value:w["b"]}),a["a"].filter("date",(function(e){if(!e)return"";let t=["January","February","March","April","May","June","July","August","September","October","November","December"],s=e.toString().split(" ")[0].replace(/-/g,"/"),a=new Date(s);return t[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()})),a["a"].config.productionTip=!1;const I=s("6ae9");I.keys().forEach(e=>{a["a"].component(e.split("/").pop().split(".")[0],I(e).default||I(e))}),new a["a"]({router:y,store:_,render:function(e){return e(d)}}).$mount("#app")},6:function(e,t){},"6ae9":function(e,t,s){var a={"./AddContact.vue":"8fd0","./Chat.vue":"e6b0","./Chats.vue":"ac11","./Conversation.vue":"107c","./Message.vue":"0f7d","./Messages.vue":"284c"};function o(e){var t=n(e);return s(t)}function n(e){if(!s.o(a,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return a[e]}o.keys=function(){return Object.keys(a)},o.resolve=n,e.exports=o,o.id="6ae9"},"6d0f":function(e,t,s){},"6dd1":function(e,t,s){"use strict";var a=s("442e"),o=s.n(a);o.a},"764a":function(e,t,s){},"7bc7":function(e,t,s){"use strict";var a=s("1ca7"),o=s.n(a);o.a},"85ec":function(e,t,s){},"8fd0":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"add-contact"},[s("div",{staticClass:"close row middle-xs"},[s("div",{staticClass:"col-xs start-xs"},[e._v(" Add Contact ")]),s("div",{staticClass:"col-xs end-xs",on:{click:e.hideWindow}},[e._v(" X ")])]),s("div",{staticStyle:{margin:"10px 10px"}},[e._v(" Show this code to the other user: ")]),s("qriously",{attrs:{value:e.personalCode,size:177}}),s("div",{staticStyle:{margin:"10px"}},[s("div",{class:[""==e.contactCode?"red-border":"green-border"],staticStyle:{"margin-bottom":"20px"},attrs:{id:"qr-window"}},[s("qrcode-stream",{on:{decode:e.onQRDecode}})],1),s("input",{directives:[{name:"model",rawName:"v-model",value:e.contactName,expression:"contactName"}],class:[""==e.contactName?"red-border":"green-border"],staticStyle:{margin:"20px 5px 10px"},attrs:{type:"text",placeholder:"Contact name"},domProps:{value:e.contactName},on:{input:function(t){t.target.composing||(e.contactName=t.target.value)}}}),s("button",{on:{click:e.addContact}},[e._v("Add Contact")])])],1)},o=[],n=s("ced0"),r={data(){return{contactName:"",contactCode:"",personalCode:this.$store.state.credentials.id+"_"+this.generatePublic()}},methods:{hideWindow(){this.$store.state.addContactVisible=!1},addContact(){if(0==this.contactName.length)return;if(!this.contactCode.includes("_"))return;let e=this.contactCode.split("_")[0],t=this.generateShared(this.contactCode.split("_")[1]),s={name:this.contactName,key:t};this.$set(this.$store.state.contacts,e,s),this.$set(this.$store.state.chats,e,[]),Object(n["b"])("contacts",this.$store.state.contacts).then(()=>{console.log("contact created..."),Object(n["b"])("chats",this.$store.state.chats).then(()=>{console.log("chat created.")})}),this.hideWindow()},generatePublic(){return this.dh("3",this.$store.state.credentials.secret,this.$store.state.publicMod)},generateShared(e){return this.dh(e,this.$store.state.credentials.secret,this.$store.state.publicMod)},dh(e,t,s){let a=this.$bigInt(e),o=this.$bigInt(t),n=this.$bigInt(s);return a.modPow(o,n).toString()},onQRDecode(e){console.log(`QR code reads: ${e}`),this.contactCode=e}}},c=r,i=(s("9fbd"),s("2877")),l=Object(i["a"])(c,a,o,!1,null,"5d5daf72",null);t["default"]=l.exports},"9d4e":function(e,t,s){},"9fbd":function(e,t,s){"use strict";var a=s("9d4e"),o=s.n(a);o.a},a17d:function(e,t,s){"use strict";var a=s("d53d"),o=s.n(a);o.a},ac11:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"chats"},[s("div",{staticClass:"add-contact row middle-xs"},[s("div",{staticClass:"col-xs-11 start-xs",on:{click:e.showWindow}},[e._v(" + Add New Contact ")]),"sm"===e.$mq?s("div",{staticClass:"col-xs-1 end-xs",on:{click:e.closeWindow}},[e._v(" X ")]):e._e()]),s("div",{staticClass:"chat-items"},e._l(e.$store.state.contacts,(function(t,a){return s("chat",{class:{selected:a==e.$store.state.selectedChat},attrs:{contact:a}})})),1)])},o=[],n={data(){return{}},methods:{showWindow(){this.$store.state.addContactVisible=!0},closeWindow(){this.$store.state.contactsVisible=!1}}},r=n,c=(s("b20d"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"da8a5046",null);t["default"]=i.exports},b20d:function(e,t,s){"use strict";var a=s("d83f"),o=s.n(a);o.a},d53d:function(e,t,s){},d83f:function(e,t,s){},e6b0:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"chat-item row middle-xs",on:{click:e.selectChat}},[s("div",{staticClass:"user col-xs-12"},[e._v(" "+e._s(e.$store.state.contacts[e.contact].name)+" ")]),0!=e.$store.state.chats[e.contact].length?s("div",{staticClass:"last-message col-xs-12"},[e._v(" "+e._s(e.$store.state.chats[e.contact][e.$store.state.chats[e.contact].length-1].content)+" ")]):e._e()])},o=[],n={props:["contact"],methods:{selectChat(){this.$store.state.selectedChat=this.contact,this.$store.state.contactsVisible=!1,this.$cookies.set("selectedChat",this.$store.state.selectedChat)}}},r=n,c=(s("450e"),s("2877")),i=Object(c["a"])(r,a,o,!1,null,"5c1c6801",null);t["default"]=i.exports}});
//# sourceMappingURL=app.c398338d.js.map